<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Watershed Report Explorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='8' fill='%232d4b91'/%3E%3Ctext x='32' y='44' font-size='36' text-anchor='middle' fill='white' font-family='Arial,sans-serif'%3EW%3C/text%3E%3C/svg%3E">
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 0; background:#111; color:#eee; }
    header { padding: 1rem 1.5rem; background:#222; display:flex; gap:1rem; align-items:center; }
    h1 { margin:0; font-size:1.2rem; font-weight:600; letter-spacing:.5px; }
    #status { font-size:.8rem; opacity:.7; }
    main { padding: 1rem 1.5rem 3.2rem; }
    .controls { display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; }
    input[type=search], input[type=text], select { padding:.5rem .65rem; border-radius:4px; border:1px solid #444; background:#1b1b1b; color:#eee; font-size:.75rem; }
    table { width:100%; border-collapse:collapse; font-size:.78rem; }
    th, td { padding:.45rem .55rem; border-bottom:1px solid #272727; vertical-align:top; }
    th { text-align:left; background:#181818; position:sticky; top:0; z-index:2; font-weight:500; font-size:.65rem; letter-spacing:.5px; }
    tbody tr:hover { background:#1c1c1c; }
    .pill { display:inline-block; padding:0 .5rem; border-radius:999px; background:#2d2d2d; font-size:.55rem; text-transform:uppercase; letter-spacing:.5px; margin-right:.25rem; }
    .cost-yes { background:#2f6b2f; color:#d8ffd8; }
    .cost-no { background:#6b2f2f; color:#ffd8d8; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Courier New', monospace; }
    .fade { opacity:.6; }
    .small { font-size:.6rem; }
    footer { position:fixed; bottom:0; left:0; right:0; background:#181818; padding:.45rem .9rem; font-size:.6rem; display:flex; justify-content:space-between; color:#aaa; gap:.75rem; }
    .panel { background:#1a1a1a; padding:1rem; border:1px solid #262626; border-radius:6px; }
    details { margin-top:.35rem; }
    mark { background:#264f99; color:#fff; padding:0 .2rem; border-radius:2px; }
    .badge { background:#333; padding:.15rem .5rem; border-radius:4px; font-size:.55rem; }
    .empty { padding:1.75rem; text-align:center; font-size:.75rem; opacity:.65; }
    #tableWrap { max-height:520px; overflow:auto; border:1px solid #252525; border-radius:6px; background:#121212; }
    #detailPanel { background:#151515; }
    .sectionLabel { text-transform:uppercase; font-size:.55rem; letter-spacing:.6px; color:#999; margin-top:.75rem; margin-bottom:.25rem; }
    ul.compact { list-style:none; margin:0; padding:0; display:grid; gap:.25rem; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); }
    ul.compact li { background:#1f1f1f; padding:.35rem .45rem; border:1px solid #262626; border-radius:4px; font-size:.6rem; }
  .syn-badge { display:inline-block; background:#5a3fa3; color:#fff; font-size:.48rem; padding:.15rem .4rem; border-radius:3px; letter-spacing:.5px; margin-left:.4rem; text-transform:uppercase; }
  .origin-transformed { opacity:.85; }
  </style>
</head>
<body>
  <header>
    <h1>Watershed Report Explorer</h1>
    <div id="status" class="flex" style="display:flex;align-items:center;gap:.5rem;"></div>
  </header>
  <main>
    <section id="workflow" style="margin-bottom:1.1rem;display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));align-items:start;">
      <div class="panel">
        <h2 style="margin:0 0 .6rem;font-size:.85rem;font-weight:600;">Upload PDF</h2>
  <form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data" target="uploadFrame" onsubmit="return window.__inlineUploadHook ? window.__inlineUploadHook(event) : true;">
          <input type="file" id="pdfFile" name="file" accept="application/pdf" style="margin-bottom:.5rem;width:100%;" />
          <button type="submit" style="width:100%;padding:.55rem .75rem;background:#2d4b91;border:0;border-radius:4px;color:#fff;font-weight:600;cursor:pointer;font-size:.7rem;">Upload</button>
        </form>
        <iframe name="uploadFrame" id="uploadFrame" style="display:none;width:0;height:0;border:0;" title="upload target"></iframe>
        <div id="uploadStatus" class="small fade" style="min-height:1rem;"></div>
      </div>
      <div class="panel">
        <h2 style="margin:0 0 .6rem;font-size:.85rem;font-weight:600;">Process</h2>
        <input id="processId" type="text" placeholder="Report ID" style="width:100%;margin-bottom:.5rem;" />
        <button id="processBtn" style="width:100%;padding:.55rem .75rem;background:#2f693a;border:0;border-radius:4px;color:#fff;font-weight:600;font-size:.7rem;cursor:pointer;">Process</button>
        <div id="processStatus" class="small fade" style="min-height:1rem;margin-top:.4rem;"></div>
      </div>
      <div class="panel">
        <h2 style="margin:0 0 .6rem;font-size:.85rem;font-weight:600;">Filters</h2>
        <div class="controls" style="flex-direction:column;align-items:stretch;">
          <input id="search" type="search" placeholder="Search reports..." />
          <div style="display:flex;gap:.4rem;">
            <select id="costFilter" style="flex:1;">
              <option value="all">All</option>
              <option value="with">With Cost</option>
              <option value="without">Without Cost</option>
            </select>
            <select id="sort" style="flex:1;">
              <option value="recent">Recent</option>
              <option value="alpha">A→Z</option>
              <option value="tables">Tables</option>
              <option value="reported">Reported $</option>
              <option value="computed">Computed $</option>
              <option value="discrepancy">Δ Discrepancy</option>
              <option value="patternCount">Pattern Count</option>
            </select>
          </div>
        </div>
      </div>
      <div id="detailPanel" class="panel" style="grid-column:1/-1;">
        <h2 style="margin:0 0 .4rem;font-size:.85rem;font-weight:600;display:flex;justify-content:space-between;align-items:center;">Report Detail <span id="detailId" class="mono fade"></span></h2>
        <div id="detailContent" class="small fade">No report selected. Choose one from the table or upload/process.</div>
        <details id="accuracyPanel" style="margin-top:.75rem;">
          <summary style="cursor:pointer;font-weight:600;">Accuracy & Quality Metrics</summary>
          <div id="accuracyMetrics" class="small" style="margin-top:.5rem;display:grid;gap:.4rem;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));"></div>
          <div id="accuracyIssues" class="small" style="margin-top:.6rem;"></div>
          <div style="margin-top:.6rem;display:flex;gap:.5rem;flex-wrap:wrap;">
            <button id="exportAccuracy" class="small" style="padding:.4rem .6rem;background:#2d4b91;border:0;border-radius:4px;color:#fff;cursor:pointer;font-size:.55rem;letter-spacing:.5px;">Export Accuracy JSON</button>
          </div>
          <details style="margin-top:.75rem;">
            <summary class="small" style="cursor:pointer;font-weight:600;">Inline Help / Field Guide</summary>
            <div class="small" style="margin-top:.55rem;line-height:1.35;display:grid;gap:.55rem;">
              <div>
                <strong>Origins</strong><br>
                <span class="pill" style="background:#444;">verbatim</span> row text is shown exactly as found.<br>
                <span class="pill" style="background:#5a3fa3;">synthetic</span> system‑generated consolidation (e.g., combined management total).<br>
                <span class="pill" style="background:#333;">transformed</span> normalized (spacing/case/typo fix) with original on hover.
              </div>
              <div>
                <strong>SYN Badge</strong><br>Marks synthesized rows so they are not mistaken for literal report text. Synthetic rows still contribute to computed totals and delta checks.
              </div>
              <div>
                <strong>Zero‑FP Guard</strong><br>Transformed names must contain only tokens present in the original line; if not, the row is excluded and counted under Excluded Rows.
              </div>
              <div>
                <strong>Numeric %</strong><br>Percentage of cost cells that parsed into valid non‑negative numbers after exclusions.
              </div>
              <div>
                <strong>Authoritative Deltas</strong><br>For tables with an injected authoritative total, a delta (&gt; ±1) is flagged. Positive = computed exceeds authoritative.
              </div>
              <div>
                <strong>Classification</strong><br>Heuristic category tags (e.g., management, bmp-structural) used only for analytics; not persisted back to source.
              </div>
              <div>
                <strong>Export Accuracy JSON</strong><br>Produces a structured audit: tables, rows (names, origin, exclusion reason), metricMeta (value/unit/rate), classification, and per-table summaries.
              </div>
            </div>
          </details>
        </details>
      </div>
    </section>
  <section id="listingSection" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.35rem;">
        <div class="small fade">Double‑click a row or press View.</div>
        <div id="metaCounts" class="small fade"></div>
      </div>
      <div id="tableWrap"><div id="tableHost"></div></div>
    </section>
  </main>
  <footer>
    <div class="small">Press / to focus search • Esc clears selection</div>
    <div class="small">Workspace UI restored (listing mode)</div>
  </footer>
  <script src="/app.js?v=rev37" type="module"></script>
</body>
</html>
